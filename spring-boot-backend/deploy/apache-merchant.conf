# =====================================================
# PayGlobe Merchant - Apache Reverse Proxy Config
# Porta Spring Boot: 8986
# =====================================================

<VirtualHost *:80>
    ServerName ricevute.payglobe.it
    DocumentRoot /var/www/html

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/merchant-error.log
    CustomLog ${APACHE_LOG_DIR}/merchant-access.log combined

    # ========================================
    # ROUTE 1: API Spring Boot (priorità massima)
    # ========================================
    ProxyPreserveHost On

    # API REST Spring Boot (porta 8986)
    <Location /api/v2>
        ProxyPass http://localhost:8986/api/v2
        ProxyPassReverse http://localhost:8986/api/v2

        # Headers per forwarding
        RequestHeader set X-Forwarded-Proto "http"
        RequestHeader set X-Forwarded-Port "80"
        RequestHeader set X-Real-IP %{REMOTE_ADDR}s

        # CORS headers (se necessario)
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
        Header always set Access-Control-Max-Age "3600"

        # OPTIONS preflight
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=204,L]
    </Location>

    # ========================================
    # ROUTE 2: Actuator (health checks - NO auth)
    # ========================================
    <Location /actuator>
        ProxyPass http://localhost:8986/actuator
        ProxyPassReverse http://localhost:8986/actuator

        # Solo localhost può accedere
        Require ip 127.0.0.1 ::1
    </Location>

    # ========================================
    # ROUTE 3: Nuova Dashboard React SPA (futuro)
    # ========================================
    # <Location /merchant/dashboard>
    #     ProxyPass http://localhost:8986/dashboard
    #     ProxyPassReverse http://localhost:8986/dashboard
    # </Location>

    # ========================================
    # ROUTE 4: PHP Esistente (default)
    # ========================================
    <Directory /var/www/html/merchant>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # PHP handler
        <FilesMatch \.php$>
            SetHandler application/x-httpd-php
        </FilesMatch>
    </Directory>

    # ========================================
    # ROUTE 5: API Terminal Config (mantieni PHP pubblico per PAX devices)
    # ========================================
    Alias /api/terminal /var/www/html/merchant/api/terminal
    <Directory /var/www/html/merchant/api/terminal>
        Options -Indexes
        AllowOverride None
        Require all granted

        <FilesMatch \.php$>
            SetHandler application/x-httpd-php
        </FilesMatch>
    </Directory>

    # ========================================
    # ROUTE 6: Flags directory (SVG)
    # ========================================
    Alias /merchant/flags /var/www/html/merchant/flags
    <Directory /var/www/html/merchant/flags>
        Options -Indexes
        Require all granted
    </Directory>

</VirtualHost>

# =====================================================
# HTTPS Configuration (se certificato disponibile)
# =====================================================
#<VirtualHost *:443>
#    ServerName ricevute.payglobe.it
#
#    SSLEngine on
#    SSLCertificateFile /etc/ssl/certs/payglobe.crt
#    SSLCertificateKeyFile /etc/ssl/private/payglobe.key
#
#    # Include stessa configurazione di sopra
#    Include /etc/apache2/sites-available/apache-merchant.conf
#</VirtualHost>
